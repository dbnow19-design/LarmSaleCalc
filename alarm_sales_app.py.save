import streamlit as st

# ----- PRISER (ANPASSADE TILL DITT LARMUPPL√ÑGG) -----

BASE_OVER_70 = 30990        # Paketpris 70+
BASE_UNDER_70 = 32400       # Paketpris under 70
EXTRA_MAGNET = 1000
EXTRA_CAMERA = 2200
EXTRA_FIRE = 2000

START_FEE = 594             # eng√•ngsavgift
ADMIN_MONTHLY = 49          # per m√•nad
INSTALLATION_COST = 5000    # bakas in i m√•nadsbetalningen

PAYMENT_OPTIONS = [
    ("90 dagar (3 m√•n)", 3),
    ("12 m√•nader", 12),
    ("24 m√•nader", 24),
    ("36 m√•nader", 36),
    ("60 m√•nader", 60),
    ("72 m√•nader", 72),
    ("120 m√•nader", 120),
]


# ----- K√ÑRNLOGIK -----

def compute_plans(financed_amount):
    """R√§knar ut alla planer (m√•nad, total) f√∂r alla bindningstider."""
    plans = []
    for label, months in PAYMENT_OPTIONS:
        monthly_fin = financed_amount / months
        monthly_total = monthly_fin + ADMIN_MONTHLY
        total_cost = monthly_total * months + START_FEE
        plans.append({
            "label": label,
            "months": months,
            "monthly": monthly_total,
            "total": total_cost,
        })
    return plans


def choose_best_plan_for_budget(plans, target_monthly):
    """
    V√§lj b√§sta plan f√∂r en given max-m√•nadskostnad:
    - Om det finns alternativ <= budget: ta det som √§r n√§rmast budget (h√∂gst monthly).
    - Annars: ta det som har l√§gst m√•nadskostnad.
    """
    under_or_equal = [p for p in plans if p["monthly"] <= target_monthly]
    if under_or_equal:
        best = max(under_or_equal, key=lambda p: p["monthly"])
        status = "within"
    else:
        best = min(plans, key=lambda p: p["monthly"])
        status = "above"
    return best, status


def choose_discount_plan_to_match_price(plans, original_monthly, tolerance):
    """
    F√∂r rabatterat uppl√§gg:
    - Hitta de planer d√§r m√•nadskostnaden ligger inom [original - tol, original + tol].
    - Bland dem: v√§lj den med kortast bindningstid.
    - Om inga i intervallet: v√§lj den med m√•nadskostnad n√§rmast original.
    """
    lower = original_monthly - tolerance
    upper = original_monthly + tolerance
    candidates = [p for p in plans if lower <= p["monthly"] <= upper]

    if candidates:
        candidates.sort(key=lambda p: (p["months"], abs(p["monthly"] - original_monthly)))
        return candidates[0], True

    best = min(plans, key=lambda p: abs(p["monthly"] - original_monthly))
    return best, False


def seller_breakdown(base_price, is_over_70, add_magnet, add_camera, add_fire,
                     charged_magnet, charged_camera, charged_fire,
                     financed_amount, plan, tag):
    """Returnerar en text med s√§ljar-detaljer."""
    extras_total_full = 0
    extras_charged = 0

    if add_magnet:
        extras_total_full += EXTRA_MAGNET
        if charged_magnet:
            extras_charged += EXTRA_MAGNET
    if add_camera:
        extras_total_full += EXTRA_CAMERA
        if charged_camera:
            extras_charged += EXTRA_CAMERA
    if add_fire:
        extras_total_full += EXTRA_FIRE
        if charged_fire:
            extras_charged += EXTRA_FIRE

    lines = []
    lines.append(f"**[{tag}] Detaljer f√∂r s√§ljare**")
    lines.append(f"- Kundkategori: {'70+' if is_over_70 else 'Under 70'}")
    lines.append(f"- Grundpris paket: {base_price:.0f} kr")
    lines.append(f"- Tillval totalt (alla): {extras_total_full:.0f} kr")
    lines.append(f"- Tillval debiterade: {extras_charged:.0f} kr")
    if add_magnet:
        lines.append(f"  - Extra magnet: {EXTRA_MAGNET} kr ({'debiteras' if charged_magnet else 'BJUDS'})")
    if add_camera:
        lines.append(f"  - Kamera: {EXTRA_CAMERA} kr ({'debiteras' if charged_camera else 'BJUDS'})")
    if add_fire:
        lines.append(f"  - Brandvarnare: {EXTRA_FIRE} kr ({'debiteras' if charged_fire else 'BJUDS'})")

    lines.append(f"- Installation som finansieras: {INSTALLATION_COST:.0f} kr")
    lines.append(f"- Totalt finansierat belopp (exkl. startavgift): {financed_amount:.0f} kr")
    lines.append(f"- Adminavgift per m√•nad: {ADMIN_MONTHLY:.0f} kr")
    lines.append(f"- Startavgift: {START_FEE:.0f} kr")
    lines.append(f"- Vald plan: {plan['label']} ({plan['months']} m√•n)")
    lines.append(f"- M√•nadskostnad: {plan['monthly']:.2f} kr")
    lines.append(f"- Totalkostnad inkl. startavgift: {plan['total']:.2f} kr")

    return "\n".join(lines)


# ----- STREAMLIT APP -----

st.set_page_config(page_title="Larm S√§ljkalkylator", layout="wide")

st.title("üìä Larm S√§ljkalkylator f√∂r s√§ljare")

st.sidebar.header("Grunddata ‚Äì Kund & produkter")

age_choice = st.sidebar.radio("Kundens √•lder", ["70 √•r eller √§ldre", "Under 70"])
is_over_70 = age_choice == "70 √•r eller √§ldre"
base_price = BASE_OVER_70 if is_over_70 else BASE_UNDER_70

st.sidebar.markdown("### Tillval som kunden vill ha")
add_magnet = st.sidebar.checkbox(f"Extra magnet ({EXTRA_MAGNET} kr)")
add_camera = st.sidebar.checkbox(f"Kamera ({EXTRA_CAMERA} kr)")
add_fire = st.sidebar.checkbox(f"Brandvarnare ({EXTRA_FIRE} kr)")

st.sidebar.markdown("---")
st.sidebar.markdown("### Rabatt / bjussa p√• produkter")
st.sidebar.caption("V√§lj vilka produkter kunden f√•r, men som du inte tar betalt f√∂r.")

charged_magnet = add_magnet and not st.sidebar.checkbox("Bjud p√• magnet", value=False)
charged_camera = add_camera and not st.sidebar.checkbox("Bjud p√• kamera", value=False)
charged_fire = add_fire and not st.sidebar.checkbox("Bjud p√• brandvarnare", value=False)

st.sidebar.markdown("---")
mode = st.sidebar.radio(
    "Hur vill du r√§kna fram utg√•ngspriset?",
    ["V√§lj bindningstid sj√§lv", "Utg√• fr√•n kundens maxpris per m√•nad"]
)

tolerance = st.sidebar.slider(
    "Till√•ten skillnad i m√•nadspris vid rabatt (¬± kr)",
    min_value=0, max_value=500, value=50, step=10
)

# ---- R√ÑKNA STANDARDERBJUDANDE (UTAN BJUSS) ----

extras_total_full = 0
if add_magnet:
    extras_total_full += EXTRA_MAGNET
if add_camera:
    extras_total_full += EXTRA_CAMERA
if add_fire:
    extras_total_full += EXTRA_FIRE

financed_full = base_price + extras_total_full + INSTALLATION_COST
plans_full = compute_plans(financed_full)

st.subheader("1Ô∏è‚É£ Standarderbjudande (utan rabatt)")

col_left, col_right = st.columns(2)

with col_left:
    if mode == "V√§lj bindningstid sj√§lv":
        label_list = [p["label"] for p in plans_full]
        selected_label = st.selectbox("V√§lj bindningstid", label_list)
        selected_plan_full = next(p for p in plans_full if p["label"] == selected_label)
        budget_status_text = ""
    else:
        max_monthly = st.number_input(
            "Kundens maxpris per m√•nad (kr/m√•n)",
            min_value=0.0, value=800.0, step=50.0
        )
        selected_plan_full, status = choose_best_plan_for_budget(plans_full, max_monthly)
        if status == "within":
            budget_status_text = f"Planen ligger inom kundens budget ({max_monthly:.0f} kr/m√•n)."
        else:
            budget_status_text = (
                f"Inga planer under kundens budget ({max_monthly:.0f} kr/m√•n). "
                f"Visar l√§gsta m√∂jliga m√•nadskostnad."
            )

    st.markdown(f"**Vald plan:** {selected_plan_full['label']}")
    st.write(f"üí∞ M√•nadskostnad: **{selected_plan_full['monthly']:.2f} kr/m√•n**")
    st.write(f"‚è± Bindningstid: **{selected_plan_full['months']} m√•nader**")
    st.write(f"üì¶ Totalkostnad inkl. startavgift: **{selected_plan_full['total']:.2f} kr**"
